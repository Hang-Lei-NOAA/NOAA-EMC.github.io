<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>NEMS: Step 2. Updating AppBuilder</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="make-images-fit.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NEMS
   &#160;<span id="projectnumber">master@eee10ef0fe</span>
   </div>
   <div id="projectbrief">This is a living document and may be updated at any time.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_how_to_old_to_new_app_builder.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Step 2. Updating AppBuilder </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Step 2.1: </h2>
<p>The next step is to figure out which modules are need for the new app. The first thing to do is to figure out which module files the copied app is using. To do this, open the existing *.appBuilder files. </p><pre class="fragment">$ ls *.appBuilder
standaloneGSM.appBuilder  standaloneGSM%gocart.appBuilder
</pre><p>For this case there are two choices and the relevant part of the file is: </p><pre class="fragment">case "$FULL_MACHINE_ID" in
    yellowstone|gaea)
        CHOSEN_MODULE=$FULL_MACHINE_ID/ESMF_NUOPC
        ;;
    wcoss*|theia)
        CHOSEN_MODULE=$FULL_MACHINE_ID/ESMF_700_gsm
        CONFOPT="gsm_intel_${MACHINE_ID:?}"
        ;;
esac
</pre><p>The variable <code>CHOSEN_MODULE</code> corresponds to a file in the <code>modulefiles/&lt;FULL_MACHINE_ID&gt;</code> directory.</p>
<p>In this case, we'll use Theia as our first target. Theia is using ESMF_700_gsm (therefor the modules listed in <code>modulefiles/theia/ESMF_700_gsm</code>).</p>
<dl class="section note"><dt>Note</dt><dd>A similar procedure would be used for other platforms. Note that wcoss.phase2 is simply a link from wcoss.phase1.</dd></dl>
<h2>Step 2.2: </h2>
<p>Copy the modulefile used in Step 2.1 to start a new modulefile for your app: </p><pre class="fragment">svn cp modulefiles/theia/ESMF_700_gsm   modulefiles/theia/ESMF_700_gsm_ww3 
</pre><h2>Step 2.3: </h2>
<p>Compare the modules in your new file (in this case <code>modulefiles/theia/ESMF_700_gsm_ww3</code>) to the module files used in your old app. In your old app structure, you can determine which modules were used by looking in the <code>*.appBuilder</code> file in the <code>environment_&lt;platform&gt;()</code> functions. Update the module file with any needed modules. You will need to check for the following things:</p>
<p>The first line must be <code>#Module#</code> This can be followed by additional <code>#</code>, eg: </p><pre class="fragment">#%Module#####################################################################
</pre><p>There should be no source commands, for example: </p><pre class="fragment">source /etc/profile 
</pre><p>Make sure there are no bash specific code such as export statements. Avoid using user installed module files when possible. For example: </p><pre class="fragment">module use /scratch4/NCEPDEV/nems/save/USER.NAME/Modulefiles
</pre><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000031">Todo:</a></b></dt><dd>These should be put somewhere in documentation about module files and then we should link to that location </dd></dl>
<h2>Step 2.4: </h2>
<p>Check the <code>*.appBuilder</code> file to see if there is a variable <code>CONFOPT</code> specified, for example, in the NEMSfv3gfs: </p><pre class="fragment">CONFOPT=configure.fv3.$FULL_MACHINE_ID
</pre><p>This configure file is located in the top level directory conf/. If no CONFOPT is specified, the default is to use </p><pre class="fragment">`configure.nems.&lt;platform&gt;.&lt;compiler&gt;`
</pre><p>Most likely, the default configure file is what you will want to use, but you should confirm that the settings are correct for your component. In general, these store compilation and link time variables.</p>
<p>To see the current state of the new app, see the following tag:</p>
<ul>
<li><a href="https://svnemc.ncep.noaa.gov/projects/nems/apps/UGCS-Weather/tags/NEMSTutorial/Step11">https://svnemc.ncep.noaa.gov/projects/nems/apps/UGCS-Weather/tags/NEMSTutorial/Step11</a></li>
</ul>
<h2>Step 2.5: </h2>
<p>We need to create a new *.appBuilder file. To do this start by copying an existing *.appBuilder file that is as similar as possible to your target application: </p><pre class="fragment">svn copy standaloneGSM.appBuilder coupledGSM_WW3.appBuilder
</pre><h2>Step 2.6: </h2>
<p>Now you need to update the new <code>*.appBuilder</code> file to include your desired components. For this app, that's adding WW3, which included the following:</p>
<ol type="1">
<li>Added WW3 to the list of components. Note there must be a space after the component name and before the ), ie: <pre class="fragment">COMPONENTS=( GSM WW3 )
</pre></li>
<li>Add the install and source directories, ie. set the <code>&lt;APP&gt;_BINDIR</code> and <code>&lt;APP&gt;_SRCDIR</code> variables. You should find the locations of these files in your old app structure's <code>*.appBuilder</code> file. In this case, for WW3: <pre class="fragment"># WW3
WW3_SRCDIR=$ROOTDIR/WW3
WW3_BINDIR=$ROOTDIR/WW3-INSTALL
</pre></li>
<li>Make sure you are pointing to the correct module files for each platform that you have created a new module file for. In this case, we have updated for Theia.</li>
</ol>
<p>To see the current state, see the tag:</p>
<ul>
<li><a href="https://svnemc.ncep.noaa.gov/projects/nems/apps/UGCS-Weather/tags/NEMSTutorial/Step13">https://svnemc.ncep.noaa.gov/projects/nems/apps/UGCS-Weather/tags/NEMSTutorial/Step13</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
