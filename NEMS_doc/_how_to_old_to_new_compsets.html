<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>NEMS: Step 4. Transition to new Compsets</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="make-images-fit.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NEMS
   &#160;<span id="projectnumber">master@2db048d501</span>
   </div>
   <div id="projectbrief">This is a living document and may be updated at any time.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_how_to_old_to_new_compsets.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Step 4. Transition to new Compsets </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Step 4.1: </h2>
<p>Now it is time to start transitioning to the new compsets. Additional documentation on compsets can be found here. To create a new compset, start by copying the compset/*.input that is the most similar to what you will be running, which is compset/gsm.input in this example: </p><pre class="fragment">cd compset
svn cp gsm.input gsm_ww3.input
</pre><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000039">Todo:</a></b></dt><dd>link to compsets above step 4.1</dd></dl>
<h2>Step 4.2: </h2>
<p>In your new compset file (compset/gsm_ww3.input), you will want to delete all unneeded tests/compsets keeping only one that you will update for your case. If using gsm.input, delete everything except the gfs_slg or gfs_eulerian test and change "`test gfs_&lt;test&gt;`" to "`compset
your_compset_name`". Note, any <code>%</code> signs in the compset name should be replaced with <code>@</code> signs.</p>
<p>In this example, we are converting the old compset <a href="https://svnemc.ncep.noaa.gov/projects/nems/branches/UGCS-Seasonal/twoWayWW3_from_r80562/compsets/cfsr%2520150401_1day_leapfrog_gsm%25slg%25T126_ww3%25t188">cfsr%20150401_1day_leapfrog_gsmslgT126_ww3t188</a></p>
<p>So we will change <code>test gfs_slg</code>, to: </p><pre class="fragment">compset cfsr@20150401_1day_blocked_gsm@slg@T126_ww3@t188 
</pre><h2>Step 4.3: </h2>
<p>The next step is to delete any builds you do not need and create any builds that you do need. In this example, we do the following:</p>
<ul>
<li>We are starting with the gsm.x build, as we do not need gocart.</li>
<li>Next we rename gsm.x to gsm_ww3.x This has to be changed in the <code>build gsm.x</code> command as well as in the variables NEMS.x and modules.nems</li>
<li>Lastly, we need to update the name of the app= in the build variable. This is the app name that appears in the appBuilder file (<code>&lt;appname&gt;.appBuilder</code>) that you created in the top level of your directory. For this case, this is coupledGSM_WW3.</li>
<li>Delete any other builds you do not need, which in this case is build gsm_gocart.x.</li>
</ul>
<h2>Step 4.4: </h2>
<p>Connect the new build to the compset. This should be in the top line where we replaced gsm.x with gsm_ww3.x and in the build=gsm.x with build=gsm_ww3.x line. This is in two places. The first is the dependency list: </p><pre class="fragment">compset cfsr@20150401_1day_blocked_gsm@slg@T126_ww3@t188: gsm_ww3.x {
</pre><p>The second is the build variable: </p><pre class="fragment">build=gsm_ww3.x
</pre><h2>Step 4.5: </h2>
<p>Update the compset description in the variable </p><pre class="fragment">TEST_DESCR=
</pre><p>which can simply be copying the definition from the old compset.</p>
<h2>Step 4.6: </h2>
<p>Update the CNTL_NAME variable, which should be the name of the subdirectory that contains the baseline data. CNTL_DIR directory name).i</p>
<p>Update the CNTL_NAME variable, which should be the name of the subdirectory that contains the baseline data. (Potentially the CNTL_DIR directory name in the old compset). </p><pre class="fragment">CNTL_NAME='cfsr@20150401_1day_blocked_gsm@slg@T126_ww3@t188'
</pre><h2>Step 4.7: </h2>
<p>Set up the initial condition and baseline directory path variables. To do this, we first look at the old compset where we have </p><pre class="fragment">export IC_DIR=$DATADIR/GSM/T126_CFSR_mask%0.5
</pre><p>In the new compset, we now set: </p><pre class="fragment">GSM_IC_NAME="GSM/T126_CFSR_mask%0.5"
GSM_IC_DIR="@[plat%BASELINE]/@[GSM_IC_NAME]"
CNTL="@[plat%BASELINE]/RT-Baselines/@[CNTL_NAME]"
</pre><p>Note that the "`@[plat%BASELINE]`" replaces the <code>$DATADIR</code> in the old compset and gives you the platform specific folders. Note <code>BASELINE</code> for each platform is defined in the params.input file in the compsets directory.</p>
<h2>Step 4.8: </h2>
<p>Now we need to update all.input replacing <code>gsm.input</code> to the name of the file you created (in this case gsm_ww3.input), ie: </p><pre class="fragment">load 'gsm.input'
</pre><p>becomes </p><pre class="fragment">load 'gsm_ww3.input'
</pre><p>Now we update the following line: </p><pre class="fragment">run gfs_slg                @ gfs, standard, baseline, slg
</pre><p>to correspond to the compset we just created: </p><pre class="fragment">run cfsr@20150401_1day_blocked_gsm@slg@T126_ww3@t188  @ gfs, standard, baseline, slg
</pre><p>After the @ sign in the above line are keywords that allow you to define sets of compsets. For any given set of compsets that have bitwise identical output (and hence the same CNTL variable), one and only one of the compsets should have the keyword "baseline". In general, this means that all compsets should have "baseline". The only exceptions are when several compsets intentionally have identical output, such as for testing bitwise identicality of thread or decomposition changes.</p>
<p>For this case, we will use "gfs, ww3, standard, baseline, slg" for keywords: </p><pre class="fragment">run cfsr@20150401_1day_blocked_gsm@slg@T126_ww3@t188  @ gfs, ww3, standard, baseline, slg
</pre><p>All other run lines that correspond to deleted compsets in gsm_ww3.input are also removed here.</p>
<h2>Step 4.9: </h2>
<p>Next, make the input directory. You will need to start with the NEMSGSM data directory for your platform because it contains the latest FIXGLOBAL and other files. If your platform doesn't have that data, you need to copy it from a platform that does. You can find the directories in platforms.input, jet.input, and wcoss.input in the compsets/ directory. For example, for Theia: </p><pre class="fragment">BASELINE="/scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/NEMSGSM/trunk-20170213/data"
</pre><p>*/</p>
<p>/**</p>
<p>Make a copy of that directory, from the trunk-(date) level, in your application-specific area of the RT directory. The directory structure looks like this: </p><pre class="fragment">RT/(AppName)/(Branch-or-trunk)-(revision-or-date)
</pre><p>The RT directory exists at these locations: </p><pre class="fragment">Theia: /scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT
WCOSS 1 &amp; 2: /nems/noscrub/emc.nemspara/RT
WCOSS Cray: /gpfs/hps/emc/nems/noscrub/emc.nemspara/RT
Jet: /lfs3/projects/hfv3gfs/emc.nemspara/RT/
</pre><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000040">Todo:</a></b></dt><dd>confirm that Jet's RT is /lfs3/projects/hfv3gfs/emc.nemspara/RT/ </dd></dl>
<p>In our case, we place our data here: </p><pre class="fragment">/scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/UGCS-Weather/UpdateStructure-20170531
</pre><p>*/ /**</p>
<p>If you do not have emc.nemspara access, then place the data in your personal area and have an application code manager copy it for you.</p>
<p>Now, copy the data:</p>
<p>*/ /** </p><pre class="fragment">mkdir -p /scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/UGCS-Weather/UpdateStructure-20170531
cd /scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/UGCS-Weather/UpdateStructure-20170531
rsync -arv /scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/NEMSGSM/trunk-20170213/data/. .
mkdir RT-Baselines
</pre><p>*/</p>
<p>/**</p>
<p>Next, update the BASELINE and BASELINE_TEMPLATE in compsets/platforms.input: </p><pre class="fragment">BASELINE="/scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/UGCS-Weather/UpdateStructure-20170531"
BASELINE_TEMPLATE="@[BASELINE]"
</pre><p>Note, compsets/platforms.input gets information for wcoss from compsets/wcoss.input.</p>
<h2>Step 4.10: </h2>
<p>Within the baseline directory that you just copied, there is a file called REGTEST-FINGERPRINT.md which must be updated. This file documents the compset input and baseline data stored outside the repository. It also serves as a verification method to ensure the data directory in use matches the one desired by this version of the application. Therefore, anytime there is an update to the compset inputs or baseline data, this file needs to be updated in the data storage area and in the repository.</p>
<p>So the two files that much match are: </p><pre class="fragment">/scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/UGCS-Weather/UpdateStructure-20170531/REGTEST-FINGERPRINT.md
/&lt;path to svn app directory&gt;/parm/REGTEST-FINGERPRINT.md
</pre><p>We updated the file in </p><pre class="fragment">/scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/UGCS-Weather/UpdateStructure-20170531/REGTEST-FINGERPRINT.md
</pre><p>and copied those changes to our local copy of /parm/REGTEST-FINGERPRINT.md.</p>
<h2>Step 4.11: </h2>
<p>Now we need to copy ALL of the needed initial conditions and other needed inputs from GSM for the compset in the input directory, that we specified in the gsm_ww3.input. In this case, we have: </p><pre class="fragment">GSM_IC_NAME="GSM/T126_CFSR_mask%0.5"
GSM_IC_DIR="@[plat%BASELINE]/@[GSM_IC_NAME]"
</pre><p>So for theia, this would correspond to: </p><pre class="fragment">/scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/UGCS-Weather/UpdateStructure-20170531/GSM/T126_CFSR_mask%0.5
</pre><p> */</p>
<p>/**</p>
<p>So first, we make this directory:</p>
<p>*/ /** </p><pre class="fragment">mkdir -p /scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/UGCS-Weather/UpdateStructure-20170531/GSM/T126_CFSR_mask%0.5
cd /scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/UGCS-Weather/UpdateStructure-20170531/GSM/T126_CFSR_mask%0.5
</pre><p>*/</p>
<p>/**</p>
<p>To find where your initial condition data was originally stored, look in your original compset </p><pre class="fragment">export IC_DIR=$DATADIR/GSM/T126_CFSR_mask%0.5
</pre><p>We find the value of DATADIR in NEMS/NEMSCompsetRun by looking in the correct platforms definition so for theia: </p><pre class="fragment">export DATADIR=/scratch4/NCEPDEV/nems/noscrub/NEMS-Data
</pre><p>*/</p>
<p>/**</p>
<p>Then copy the data:</p>
<p>*/ /** </p><pre class="fragment">rsync -arv /scratch4/NCEPDEV/nems/noscrub/NEMS-Data/GSM/T126_CFSR_mask%0.5/. .
</pre><p>*/</p>
<p>/**</p>
<h2>Step 4.12: </h2>
<p>The next step is to get initial conditions and inputs for each of your other components. You can find where these files are using your old app, compset and NEMSCompsetRun. First, look in your old compset for component specific set up calls, ie: </p><pre class="fragment"># - component specific setup calls ---
setup_ww3Case2
</pre><p>And then find the corresponding code in the old NEMS/NEMSCompsetRun: </p><pre class="fragment">setup_ww3Case2(){
  if [ $MACHINE_ID = theia ] ; then
    cp -r /scratch4/NCEPDEV/nems/noscrub/Jessica.Meixner/esmf_files/Case2_20160831/* ${RUNDIR}/.
  elif [ $MACHINE_ID = wcoss ] ; then
    cp -r /marine/noscrub/Jessica.Meixner/esmf_files/Case2_20170323/* ${RUNDIR}/.
  fi
}
</pre><p>Then, copy this information to a folder in your RT directory <code>RT/&lt;AppName&gt;/&lt;branch-or-trunk&gt;-&lt;date&gt;/&lt;component&gt;/&lt;description&gt;</code> ie: </p><pre class="fragment">cp -r /scratch4/NCEPDEV/nems/noscrub/Jessica.Meixner/esmf_files/Case2_20160831/* /scratch4/NCEPDEV/nems/noscrub/emc.nemspara/RT/UGCS-Weather/UpdateStructure-20170531/WW3/Case2 
</pre><p>*/</p>
<p>/**</p>
<h2>Step 4.13: </h2>
<p>Now within your new compset, add lines to copy the newly created directory of component specific setup files into the filters input function. This is the line below "# WW3 Specific": </p><pre class="fragment">filters input {
  # Parse any files that need variables from other scopes, and do
  # not need fancy scripting.  Presently, this is just the NEMS
  # and mediator init files.
  #           WORK FILE &lt;=method==  SOURCE
  'atmos.configure'     &lt;=atparse=  "@[CONF]/atmos.configure_gfs"
  'nems.configure'      &lt;=atparse=  "@[CONF]/nems.configure.@[nems_configure].IN"
  # WW3 Specific
                    '*' &lt;=copydir= "@[plat%BASELINE]/WW3/Case2"
}
</pre><h2>Step 4.14: </h2>
<p>Now it is time to go through your original compset and update/add appropriate values to variables in your new compset. Start with the following variables: </p><pre class="fragment">NTHREADS=1
TASKS=60
wallclock=1800 #in seconds 
walltime=1800 #wall clock limit in seconds
</pre><p>NOTE: wallclock time is now in seconds and NOT minutes.</p>
<h2>Step 4.15: </h2>
<p>Update variables in the prerun=run_exglobal_fcst section. Variable names in the new scripts match the ones in the exglobal_fcst.sh. In the old system, there were one or more aliases for the same variable and some variables set in the compset did not actually do anything. That has been corrected now, but you do need to find the correct variable names. The list of supported variables is in exglobal_fcst.input. If a variable is not in exglobal_fcst.input, check the master list of GFS variables, maintained by Kate Howard, to see the meaning of your variable and any possible synonyms. The variables in your old compset to look at are likely in the gsm configure section. Note that you should put quotes around most variable values.</p>
<p>In this section you should also define NHRS, the number of hours of simulation, instead of NDAYS as before. This is because NDAYS is subsequently internally defined as NDAYS=NHRS/24.</p>
<p>To add a new variable needs to be added, that is not already supported in exglobal_fcst.input, include it in the prerun section as well as defining it within exglobal_fcst.input.</p>
<h2>Step 4.16: </h2>
<p>Next, we need to make the <code>atmos.configure</code> and <code>nems.configure</code> files and set the appropriate coupling variables. In this case, the atmos.configure file that is used (<code>@[CONF]/atmos.configure_gfs</code>) is <code>parm/atmos.configure_gfs</code>: </p><pre class="fragment">core: gfs

atm_model:                      @[atm_model]
atm_coupling_interval_sec:      @[coupling_interval_fast_sec]
</pre><p>The <code>@[variable_names]</code> get substituted with values defined in your <code>*.input</code> file compset block. Some of these variables might have default values such as atm_model.</p>
<p>For the nems.configure file, make sure to add all the needed `@[variable_names] into your new compset as well. Most likely, this will mean copying the definition of the variables under ‘nems.configure’ section of your old compset, such as: </p><pre class="fragment"># - nems.configure ---
export_nems
export nems_configure=blocked_atm_wav
export atm_model=gsm
export atm_petlist_bounds="0 47"    
export wav_model=ww3
export wav_petlist_bounds="47 59"  
export coupling_interval_sec=1800.0  # 30min coupling
</pre><p>First note, the nems_configure variable, determines which template file to use, ie. <code>@[CONF]/nems.configure.@[nems_configure].IN</code>, which corresponds to parm/nems.configure.blocked_atm_wav.IN in this case.</p>
<p>The template file in the old structure was located in <code>NEMS/test/</code> directory. If there were any updates to these files, be sure to update them, these are now located at the app level in the <code>parm/</code> directory.</p>
<p>The <code>@[variable_names]</code> get substituted with values defined in your <code>*.input</code> file compset block. Some of these variables might have default values such as atm_model. Make sure to define any of the non-default <code>@[variable_names]</code> for the template file are defined in the new compset. For example the above <code>nems.configure</code> block in the new compset becomes:</p>
<p>Now add the needed variables in the new compset making sure to put quotes around variable names. For this example, we add: </p><pre class="fragment"># - nems.configure ---
nems_configure='blocked_atm_wav'
atm_model='gsm'
atm_petlist_bounds="0 47"
wav_model='ww3'
wav_petlist_bounds="47 59"
coupling_interval_sec=1800.0  # 30min coupling
</pre><h2>Step 4.17 </h2>
<p>Add a comment block at the top of the compset section to describe your compset. This will be automatically parsed and put with application level documentation. For this compset we added the following: </p><pre class="fragment">compset cfsr@20150401_1day_blocked_gsm@slg@T126_ww3@t188: gsm_ww3.x {
    ##! GSM-WW3 coupling with 30 minute intervals
    #
    # This compset couples:
    #
    # * Semilagrangian GSM using the T126 grid with
    # * Wavewatch3 using the t188 grid
    #
    # using a blocked coupling scheme with a  
    # 30 minute timestep.
</pre><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000041">Todo:</a></b></dt><dd>are there any other specifics for compset documentation? </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
